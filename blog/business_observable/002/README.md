# 工作流BPMN2.0来表达复杂的业务流程

## 接上篇【云工作空间项目】创建工作空间业务流程案例分析

**产品经理**经过多轮业务设计和需求分析，得到“最终”业务流程：

![业务流程图v4](./_media/业务流程图_v4.png ":size=800")

从一步步推动更新版本，业务流程从最初设计，到不断融入新的需求，流程变的越来越复杂；

这里面涉及到功能性和非功能性的需求点，**产品经理**遂去找**架构师**看看是否从架构上进行支持，

**架构师**梳理了需要解决的一些问题：

1. 流程中各个`状态`如何管理？
2. 流程中遇到执行失败，如何统一的异常处理和回滚机制？
3. 流程的`阶段`或`过程`遇到流程`阻塞`、`超时`，如何处理？
4. `流程的透明性`和`排查问题效率`：如何可视化各个流程的节点、日志、各个过程的输入参数和结果？

一番研究后，这些基本满足可以考虑使用`工作流`架构来处理这个业务流程。

### BPMN2.0 工作流设计图

**架构师**使用`BPMN2.0`工作流设计工具，设计出如下图：

![工作流_总体设计](./_media/工作流_总体设计.png )

1. `申请创建空间`任务，当用户发起创建任务请求后，任务开始
2. `分配系统资源子流程`任务，对应的业务流程的中`分配系统资源阶段`
3. `生成脚本子流程`任务，对应的业务流程的中`生成脚本阶段`
4. `执行脚本子流程`任务，对应的业务流程的中`执行脚本阶段`

接着，**架构师**细化各个子流程。

#### 细化分配系统资源工作流

![工作流_细化分配系统资源](./_media/工作流_细化分配系统资源.png ':size=800')

关于流程说明：

1. `申请创建空间`任务，流程处理后，将进入`分配系统资源子流程`，并且开始`分配系统资源`任务；
2. `分配系统资源`成功后，子流程结束，流转到下个子流程；
3. `分配系统资源`失败后，定时器循环3次，每次间隔30s，重新发起`分配系统资源`任务；
4. `分配系统资源`，若接收`取消`信号，流程进行`取消处理`的服务任务，该服务任务结束**流程终止**；
5. 对`分配系统资源子流程`，设置了超时时间，超过3分钟，子流程没有结束，流程进行`超时处理`的服务任务，该服务任务结束**流程终止**；
6. `申请创建空间`任务，同理也做了超时处理。

#### 细化生成脚本工作流

![工作流_细化生成脚本](./_media/工作流_细化生成脚本.png ':size=800')

#### 细化执行脚本工作流

![工作流_细化执行脚本](./_media/工作流_细化执行脚本.png ':size=800')

#### 展开完整的工作流

![工作流_细化展开完整](./_media/工作流_细化展开完整.png ':size=800')